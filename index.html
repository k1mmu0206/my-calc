<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—…æ—¥åŠ©æ‰‹ - æœ€çµ‚å…¼å®¹ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #f7f3f0;
            --container-bg: #ffffff;
            --coffee-dark: #5d4037;
            --coffee-medium: #8d6e63;
            --soft-beige: #efebe9;
            --primary-orange: #e67e22;
            --light-orange: #ffe0b2;
            --delete-red: #ff4d4f;
        }

        body {
            font-family: -apple-system, "Noto Sans TC", sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: 0;
            display: flex; flex-direction: column; align-items: center;
        }

        .tab-bar {
            width: 100%; max-width: 480px;
            display: flex; background: var(--container-bg);
            margin-top: 10px; border-radius: 15px 15px 0 0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            position: sticky; top: 0; z-index: 100;
        }
        .tab-btn {
            flex: 1; padding: 15px; border: none; background: none;
            color: var(--coffee-medium); cursor: pointer;
            border-bottom: 3px solid transparent; font-size: 1rem;
        }
        .tab-btn.active {
            color: var(--primary-orange); border-bottom: 3px solid var(--primary-orange); font-weight: bold;
        }

        .container {
            width: 100%; max-width: 480px;
            background: var(--container-bg);
            border-radius: 0 0 20px 20px;
            box-shadow: 0 10px 25px rgba(93, 64, 55, 0.1);
            padding: 20px; box-sizing: border-box; min-height: 90vh;
        }

        .view-section { display: none; }
        .view-section.active { display: block; }

        /* --- æ—¥æ›†ä¿®å¾©é‡é»ï¼šé€æ˜ç–ŠåŠ æ³• --- */
        .header-controls {
            display: grid;
            grid-template-columns: 50px 1fr 50px;
            align-items: center;
            margin-bottom: 15px;
        }
        .header-controls h3 { margin: 0; font-size: 1.1rem; text-align: center; color: var(--coffee-dark); }
        
        .date-picker-wrapper {
            position: relative; /* è®“å­å…ƒç´ å¯ä»¥çµ•å°å®šä½åœ¨ä¸Šé¢ */
            display: flex; justify-content: center; align-items: center;
            width: 40px; height: 40px;
        }
        .icon-btn { font-size: 1.6rem; cursor: pointer; pointer-events: none; } /* è®“é»æ“Šç©¿é€åˆ° input */
        #recordDate {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            opacity: 0; /* è®Šæˆé€æ˜ */
            cursor: pointer;
            -webkit-appearance: none; /* ä¿®å¾© iOS æ¨£å¼ */
        }

        /* è¢å¹•é¡¯ç¤º */
        .calc-display {
            background: #fff; padding: 15px; border-radius: 15px;
            text-align: right; margin-bottom: 15px; border: 2px solid var(--soft-beige);
        }
        .calc-twd { font-size: 0.9rem; color: var(--coffee-medium); margin-bottom: 4px; }
        .calc-jpy { font-size: 2.6rem; font-weight: bold; color: var(--coffee-dark); line-height: 1.2; min-height: 2.6rem; }
        .label { font-size: 0.7rem; color: #aaa; margin-right: 5px; }

        /* è¨ˆç®—æ©Ÿéµç›¤ */
        .numpad {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px;
        }
        .numpad button {
            padding: 18px 0; border: none; border-radius: 12px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer;
        }
        .numpad button:active { opacity: 0.6; }

        .btn-num { background: var(--soft-beige); color: var(--coffee-dark); font-size: 1.5rem; font-weight: bold; }
        .btn-func { background: #e7e0da; color: var(--coffee-medium); font-size: 1rem; font-weight: bold; }
        .btn-op { background: var(--light-orange); color: var(--primary-orange); font-size: 1.3rem; font-weight: bold; }
        .btn-clear { color: var(--delete-red) !important; background: #ffebeb !important; }

        /* é¡åˆ¥èˆ‡å­˜æª” */
        .category-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px;
        }
        .cat-btn {
            padding: 12px 5px; border: 1px solid var(--soft-beige);
            border-radius: 10px; background: #fff; color: var(--coffee-medium); font-size: 0.9rem;
        }
        .cat-btn.active {
            background: var(--light-orange); color: var(--primary-orange);
            border-color: var(--primary-orange); font-weight: bold;
        }
        .btn-confirm {
            width: 100%; padding: 18px; background: var(--primary-orange);
            color: white; border: none; border-radius: 12px;
            font-size: 1.2rem; font-weight: bold; box-shadow: 0 4px 0 #d35400; margin-bottom: 25px;
        }

        /* ç´€éŒ„æ¸…å–® */
        .record-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px solid #efebe9;
        }
        .record-info { flex-grow: 1; }
        .record-jpy { font-size: 1.4rem; font-weight: bold; color: var(--coffee-dark); }
        .record-twd { font-size: 0.8rem; color: var(--coffee-medium); }
        .btn-del-item {
            background: none; border: 1px solid var(--delete-red); color: var(--delete-red);
            padding: 4px 10px; border-radius: 6px; font-size: 0.8rem; cursor: pointer;
        }

        .summary-box {
            background: var(--soft-beige); padding: 15px; border-radius: 15px; text-align: center; margin-bottom: 20px;
        }
        .date-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
        .date-tag { padding: 6px 12px; border-radius: 20px; border: 1px solid var(--coffee-medium); cursor: pointer; font-size: 0.85rem; }
        .date-tag.selected { background: var(--primary-orange); color: white; border-color: var(--primary-orange); }
    </style>
</head>
<body>

<div class="tab-bar">
    <button class="tab-btn active" onclick="showView('calc', this)">æ—¥å¹£æ›ç®—è¨˜å¸³</button>
    <button class="tab-btn" onclick="showView('history', this)">æ”¯å‡ºçµ±è¨ˆ</button>
</div>

<div class="container">
    
    <!-- åˆ†é ä¸€ï¼šä¸»ä»‹é¢ -->
    <div id="view-calc" class="view-section active">
        <div class="header-controls">
            <div class="date-picker-wrapper">
                <span class="icon-btn">ğŸ“…</span>
                <!-- é€æ˜çš„æ—¥æœŸè¼¸å…¥æ¡†ç–Šåœ¨åœ–ç¤ºä¸Šé¢ -->
                <input type="date" id="recordDate" onchange="syncDateChange()">
            </div>
            <h3 id="displayDateTitle">æ—¥å¹£æ›ç®—è¨˜å¸³</h3>
            <button class="icon-btn" onclick="toggleRate()" style="font-size:1.1rem; pointer-events: auto;">âš™ï¸</button>
        </div>

        <div id="rateSection" style="display:none; margin-bottom:15px; background:var(--soft-beige); padding:10px; border-radius:10px; text-align:center;">
            <span style="font-size:0.8rem;">åŒ¯ç‡ 1 JPY = </span>
            <input type="number" id="exchangeRate" value="0.215" step="0.001" oninput="updateConverted()" style="width:70px;">
        </div>

        <div class="calc-display">
            <div class="calc-twd"><span class="label">TWD</span>$ <span id="twdDisplay">0</span></div>
            <div class="calc-jpy" id="jpyDisplay">Â¥ 0</div>
        </div>

        <!-- è¨ˆç®—æ©Ÿä½ˆå±€å„ªåŒ– -->
        <div class="numpad">
            <button class="btn-num" onclick="pressNum('7')">7</button>
            <button class="btn-num" onclick="pressNum('8')">8</button>
            <button class="btn-num" onclick="pressNum('9')">9</button>
            <button class="btn-op" onclick="pressOp('+')">+</button>

            <button class="btn-num" onclick="pressNum('4')">4</button>
            <button class="btn-num" onclick="pressNum('5')">5</button>
            <button class="btn-num" onclick="pressNum('6')">6</button>
            <button class="btn-op" onclick="pressOp('-')">âˆ’</button>

            <button class="btn-num" onclick="pressNum('1')">1</button>
            <button class="btn-num" onclick="pressNum('2')">2</button>
            <button class="btn-num" onclick="pressNum('3')">3</button>
            <button class="btn-op" onclick="pressOp('*')">Ã—</button>

            <!-- æŒ‰éˆ•é †åºï¼šå…¨åˆªé™¤ C | 0 | åˆªé™¤ âŒ« | 000 -->
            <button class="btn-func btn-clear" onclick="pressClear()">C</button>
            <button class="btn-num" onclick="pressNum('0')">0</button>
            <button class="btn-func" onclick="pressBack()">âŒ«</button>
            <button class="btn-num" onclick="pressNum('000')" style="font-size:1.1rem;">000</button>
        </div>

        <div class="category-grid">
            <button class="cat-btn" onclick="setCategory('é£²é£Ÿ', this)">é£²é£Ÿ</button>
            <button class="cat-btn" onclick="setCategory('æœè£', this)">æœè£</button>
            <button class="cat-btn" onclick="setCategory('ç”¨å“', this)">ç”¨å“</button>
            <button class="cat-btn" onclick="setCategory('è—¥å¦', this)">è—¥å¦</button>
            <button class="cat-btn" onclick="setCategory('äº¤é€š', this)">äº¤é€š</button>
            <button class="cat-btn" onclick="showCustomInput(this)">ï¼‹å…¶ä»–</button>
        </div>
        <input type="text" id="customCatInput" placeholder="è‡ªå®šç¾©é¡åˆ¥åç¨±" style="display:none; width:100%; padding:10px; margin-bottom:15px; border-radius:10px; border:1px solid #ddd; box-sizing:border-box;">

        <button class="btn-confirm" onclick="addRecord()">ç¢ºèªç´€éŒ„ä¸¦å­˜æª”</button>

        <h4 id="listTitle" style="border-left:4px solid var(--primary-orange); padding-left:10px; margin-top:10px;">ä»Šæ—¥æ¸…å–®</h4>
        <div id="calcDetailList"></div>
    </div>

    <!-- åˆ†é äºŒï¼šçµ±è¨ˆé  -->
    <div id="view-history" class="view-section">
        <h3 style="margin-top:0; text-align:center;">ğŸ“Š æ”¯å‡ºçµ±è¨ˆ</h3>
        <div class="date-tags" id="historyDateTags"></div>
        <div class="summary-box">
            <div style="font-size: 0.9rem; color: #888;">é¸å–æ—¥æœŸç¸½è¨ˆ</div>
            <div style="font-size: 2rem; font-weight: bold; color: var(--primary-orange);">$ <span id="historyTotalTWD">0</span></div>
            <div style="font-size: 0.9rem; color: #aaa;">ç´„ Â¥ <span id="historyTotalJPY">0</span></div>
        </div>
        <div style="max-width:280px; margin: 0 auto 20px;"><canvas id="historyChart"></canvas></div>
        <div id="historyDetailList"></div>
    </div>
</div>

<script>
    let currentInput = "0";
    let memoryValue = 0;
    let pendingOp = null;
    let shouldResetInput = false;

    let selectedCategory = "";
    let isCustom = false;
    let records = JSON.parse(localStorage.getItem('jpy_trip_v9')) || [];
    let historySelectedDates = []; 
    let historyChart = null;

    const todayStr = new Date().toLocaleDateString('en-CA');
    document.getElementById('recordDate').value = todayStr;

    window.onload = () => { syncDateChange(); };

    function showView(view, btn) {
        document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('view-' + view).classList.add('active');
        btn.classList.add('active');
        if(view === 'history') renderHistoryTab();
    }

    // è¨ˆç®—æ©Ÿé‚è¼¯
    function pressNum(num) {
        if (currentInput === "0" || shouldResetInput) {
            currentInput = num === "000" ? "0" : num;
            shouldResetInput = false;
        } else {
            currentInput += num;
        }
        updateDisplay();
    }

    function pressOp(op) {
        const val = parseFloat(currentInput);
        if (pendingOp && !shouldResetInput) {
            memoryValue = calculate(memoryValue, val, pendingOp);
        } else {
            memoryValue = val;
        }
        pendingOp = op;
        shouldResetInput = true;
        updateDisplay(memoryValue);
    }

    function calculate(a, b, op) {
        if (op === '+') return a + b;
        if (op === '-') return a - b;
        if (op === '*') return a * b;
        return b;
    }

    function pressClear() {
        currentInput = "0";
        memoryValue = 0;
        pendingOp = null;
        shouldResetInput = false;
        updateDisplay();
    }

    function pressBack() {
        if (currentInput.length > 1) currentInput = currentInput.slice(0, -1);
        else currentInput = "0";
        updateDisplay();
    }

    function updateDisplay(tempVal) {
        const val = (tempVal !== undefined && shouldResetInput) ? tempVal : parseFloat(currentInput);
        const rate = parseFloat(document.getElementById('exchangeRate').value) || 0;
        document.getElementById('jpyDisplay').innerText = "Â¥ " + val.toLocaleString();
        document.getElementById('twdDisplay').innerText = Math.round(val * rate).toLocaleString();
    }

    function updateConverted() { updateDisplay(); }
    function toggleRate() { const s = document.getElementById('rateSection'); s.style.display = (s.style.display === 'none') ? 'block' : 'none'; }
    
    function syncDateChange() { 
        const selectedDate = document.getElementById('recordDate').value;
        const displayLabel = selectedDate === todayStr ? "ä»Šæ—¥æ¸…å–®" : selectedDate + " æ¸…å–®";
        document.getElementById('listTitle').innerText = displayLabel;
        renderCalcList(); 
    }

    function setCategory(cat, btn) {
        isCustom = false; selectedCategory = cat;
        document.getElementById('customCatInput').style.display = 'none';
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    function showCustomInput(btn) {
        isCustom = true;
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('customCatInput').style.display = 'block';
    }

    function addRecord() {
        let finalJPY = parseFloat(currentInput);
        if (pendingOp && !shouldResetInput) {
            finalJPY = calculate(memoryValue, finalJPY, pendingOp);
        } else if (shouldResetInput) {
            finalJPY = memoryValue;
        }
        
        if (finalJPY <= 0) { alert("è«‹è¼¸å…¥é‡‘é¡"); return; }
        const cat = isCustom ? document.getElementById('customCatInput').value.trim() : selectedCategory;
        if (!cat) { alert("è«‹é¸æ“‡é¡åˆ¥"); return; }
        
        const rate = parseFloat(document.getElementById('exchangeRate').value) || 0;
        const targetDate = document.getElementById('recordDate').value;

        records.push({ id: Date.now(), date: targetDate, category: cat, jpy: finalJPY, twd: Math.round(finalJPY * rate) });
        save();
        renderCalcList();
        pressClear();
    }

    function deleteRecord(id) {
        if (confirm("ç¢ºå®šè¦åˆªé™¤æ­¤ç­†ç´€éŒ„å—ï¼Ÿ")) {
            records = records.filter(r => r.id !== id);
            save();
            renderCalcList();
            if (document.getElementById('view-history').classList.contains('active')) renderHistoryTab();
        }
    }

    function renderCalcList() {
        const targetDate = document.getElementById('recordDate').value;
        const list = document.getElementById('calcDetailList');
        const filtered = records.filter(r => r.date === targetDate);
        if(filtered.length === 0) { list.innerHTML = "<p style='text-align:center;color:#aaa;font-size:0.8rem;margin-top:15px;'>å°šç„¡ç´€éŒ„</p>"; return; }
        list.innerHTML = filtered.sort((a,b)=>b.id-a.id).map(r => `
            <div class="record-item">
                <div class="record-info">
                    <div><b>${r.category}</b></div>
                    <div style="display:flex; align-items:baseline; gap:10px;">
                        <span class="record-jpy">Â¥${r.jpy.toLocaleString()}</span>
                        <span class="record-twd">$${r.twd.toLocaleString()} TWD</span>
                    </div>
                </div>
                <button class="btn-del-item" onclick="deleteRecord(${r.id})">åˆªé™¤</button>
            </div>
        `).join('');
    }

    function renderHistoryTab() {
        const tagContainer = document.getElementById('historyDateTags');
        const uniqueDates = [...new Set(records.map(r => r.date))].sort().reverse();
        tagContainer.innerHTML = uniqueDates.map(d => `<div class="date-tag ${historySelectedDates.includes(d) ? 'selected' : ''}" onclick="toggleHistoryDate('${d}')">${d}</div>`).join('');
        updateHistoryStats();
    }

    function toggleHistoryDate(date) {
        if(historySelectedDates.includes(date)) historySelectedDates = historySelectedDates.filter(d => d !== date);
        else historySelectedDates.push(date);
        renderHistoryTab();
    }

    function updateHistoryStats() {
        const filtered = records.filter(r => historySelectedDates.includes(r.date));
        const list = document.getElementById('historyDetailList');
        let totalTWD = 0, totalJPY = 0, catStats = {};
        filtered.forEach(r => {
            totalTWD += r.twd; totalJPY += r.jpy;
            catStats[r.category] = (catStats[r.category] || 0) + r.twd;
        });
        document.getElementById('historyTotalTWD').innerText = totalTWD.toLocaleString();
        document.getElementById('historyTotalJPY').innerText = totalJPY.toLocaleString();
        const ctx = document.getElementById('historyChart').getContext('2d');
        if(historyChart) historyChart.destroy();
        if(Object.keys(catStats).length > 0) {
            historyChart = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: Object.keys(catStats), datasets: [{ data: Object.values(catStats), backgroundColor: ['#e67e22', '#8d6e63', '#d7ccc8', '#ffe0b2', '#5d4037'], borderWidth: 2 }] },
                options: { plugins: { legend: { position: 'bottom' } } }
            });
        }
        list.innerHTML = filtered.sort((a,b)=>b.id-a.id).map(r => `
            <div class="record-item">
                <div class="record-info">
                    <div style="font-size:0.85rem;"><b>${r.category}</b> <span style="color:#aaa;margin-left:5px;">${r.date}</span></div>
                    <div style="display:flex; align-items:baseline; gap:10px;">
                        <span class="record-jpy">Â¥${r.jpy.toLocaleString()}</span>
                        <span class="record-twd">$${r.twd.toLocaleString()}</span>
                    </div>
                </div>
                <button class="btn-del-item" onclick="deleteRecord(${r.id})">åˆªé™¤</button>
            </div>
        `).join('');
    }

    function save() { localStorage.setItem('jpy_trip_v9', JSON.stringify(records)); }
</script>
</body>
</html>
